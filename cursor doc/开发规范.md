# å¼€å‘è§„èŒƒæ–‡æ¡£

## ğŸ“‘ ç›®å½•
- [1. ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ](#1-ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ)
- [2. ä»£ç æäº¤è§„èŒƒ](#2-ä»£ç æäº¤è§„èŒƒ)
- [3. æµ‹è¯•è§„èŒƒ](#3-æµ‹è¯•è§„èŒƒ)
- [4. ä»£ç å®¡æŸ¥è§„èŒƒ](#4-ä»£ç å®¡æŸ¥è§„èŒƒ)
- [5. å®‰å…¨ç¼–ç è§„èŒƒ](#5-å®‰å…¨ç¼–ç è§„èŒƒ)
- [6. å¤šç§Ÿæˆ·å¼€å‘è§„èŒƒ](#6-å¤šç§Ÿæˆ·å¼€å‘è§„èŒƒ)
- [7. APIå¼€å‘è§„èŒƒ](#7-apiå¼€å‘è§„èŒƒ)
- [8. æ–‡æ¡£åŒæ­¥è§„èŒƒ](#8-æ–‡æ¡£åŒæ­¥è§„èŒƒ)

---

## 1. ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ

### 1.1 åˆ†æ”¯ç®¡ç†ç­–ç•¥

#### ğŸŒ³ GitFlow å·¥ä½œæµ
æˆ‘ä»¬é‡‡ç”¨ **GitFlow** åˆ†æ”¯æ¨¡å‹ï¼Œç¡®ä¿ä»£ç ç®¡ç†çš„æ ‡å‡†åŒ–å’Œå‘å¸ƒçš„å¯æ§æ€§ã€‚

| åˆ†æ”¯ç±»å‹ | åˆ†æ”¯åç§° | ä½œç”¨ | åˆ›å»ºæ¥æº | åˆå¹¶ç›®æ ‡ |
|---------|----------|------|----------|----------|
| **ä¸»åˆ†æ”¯** | `main` | ç”Ÿäº§ç¯å¢ƒä»£ç  | - | - |
| **å¼€å‘åˆ†æ”¯** | `develop` | å¼€å‘é›†æˆåˆ†æ”¯ | `main` | `main` |
| **åŠŸèƒ½åˆ†æ”¯** | `feature/åŠŸèƒ½å` | æ–°åŠŸèƒ½å¼€å‘ | `develop` | `develop` |
| **å‘å¸ƒåˆ†æ”¯** | `release/v1.0.0` | é¢„å‘å¸ƒæµ‹è¯• | `develop` | `main` & `develop` |
| **ä¿®å¤åˆ†æ”¯** | `hotfix/é—®é¢˜æè¿°` | ç´§æ€¥ä¿®å¤ | `main` | `main` & `develop` |

#### ğŸ“‹ åˆ†æ”¯å‘½åè§„èŒƒ
```bash
# åŠŸèƒ½åˆ†æ”¯
feature/user-login           # ç”¨æˆ·ç™»å½•åŠŸèƒ½
feature/message-encryption   # æ¶ˆæ¯åŠ å¯†åŠŸèƒ½
feature/llm-integration     # LLMé›†æˆåŠŸèƒ½

# å‘å¸ƒåˆ†æ”¯
release/v1.0.0              # 1.0.0ç‰ˆæœ¬å‘å¸ƒ
release/v1.1.0-beta         # 1.1.0æµ‹è¯•ç‰ˆ

# ä¿®å¤åˆ†æ”¯
hotfix/security-patch       # å®‰å…¨è¡¥ä¸
hotfix/database-connection   # æ•°æ®åº“è¿æ¥ä¿®å¤
```

### 1.2 åˆ†æ”¯ä¿æŠ¤è§„åˆ™

#### ğŸ”’ ä¿æŠ¤ç­–ç•¥
```yaml
mainåˆ†æ”¯ä¿æŠ¤:
  - ç¦æ­¢ç›´æ¥æ¨é€
  - å¿…é¡»é€šè¿‡PRåˆå¹¶
  - è¦æ±‚è‡³å°‘1ä¸ªå®¡æ‰¹
  - å¿…é¡»é€šè¿‡CI/CDæ£€æŸ¥
  - è¦æ±‚åˆ†æ”¯ä¸ºæœ€æ–°çŠ¶æ€

developåˆ†æ”¯ä¿æŠ¤:
  - ç¦æ­¢ç›´æ¥æ¨é€
  - å¿…é¡»é€šè¿‡PRåˆå¹¶
  - è¦æ±‚é€šè¿‡åŸºæœ¬CIæ£€æŸ¥
```

---

## 2. ä»£ç æäº¤è§„èŒƒ

### 2.1 Conventional Commits è§„èŒƒ

#### ğŸ“ æäº¤æ¶ˆæ¯æ ¼å¼
```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

#### ğŸ·ï¸ æäº¤ç±»å‹è¯´æ˜
| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **feat** | æ–°å¢åŠŸèƒ½ | `feat(auth): add user login endpoint` |
| **fix** | ä¿®å¤Bug | `fix(database): resolve N+1 query in session list` |
| **docs** | æ–‡æ¡£æ›´æ–° | `docs(api): update authentication documentation` |
| **style** | ä»£ç æ ¼å¼è°ƒæ•´ | `style: fix indentation in user service` |
| **refactor** | ä»£ç é‡æ„ | `refactor(llm): extract context builder` |
| **test** | æµ‹è¯•ç›¸å…³ | `test(auth): add unit tests for login service` |
| **chore** | æ„å»ºé…ç½®ç­‰ | `chore: update dependencies` |
| **perf** | æ€§èƒ½ä¼˜åŒ– | `perf(query): optimize message search query` |

#### âœ… è‰¯å¥½æäº¤ç¤ºä¾‹
```bash
feat(tenant): add multi-tenant data isolation

- Implement tenant_id filtering in all database queries
- Add tenant context middleware for API requests
- Update user authentication to include tenant validation

Closes #123
```

#### âŒ ä¸è‰¯æäº¤ç¤ºä¾‹
```bash
fix bug          # è¿‡äºç®€å•
update code      # æ²¡æœ‰å…·ä½“ä¿¡æ¯
WIP             # å·¥ä½œè¿›è¡Œä¸­çš„æäº¤ä¸åº”åˆå¹¶
```

### 2.2 æäº¤æœ€ä½³å®è·µ

#### ğŸ“ æäº¤ç²’åº¦
- **å°è€Œé¢‘ç¹**: æ¯æ¬¡æäº¤åªåŒ…å«ä¸€ä¸ªé€»è¾‘å˜æ›´
- **ç‹¬ç«‹å®Œæ•´**: æ¯æ¬¡æäº¤éƒ½åº”è¯¥æ˜¯å¯æ„å»ºã€å¯æµ‹è¯•çš„
- **åŸå­æ€§**: ç›¸å…³çš„æ–‡ä»¶ä¿®æ”¹åº”è¯¥åœ¨åŒä¸€æ¬¡æäº¤ä¸­

#### ğŸ” æäº¤å‰æ£€æŸ¥æ¸…å•
- [ ] ä»£ç å·²é€šè¿‡æœ¬åœ°æµ‹è¯•
- [ ] ä»£ç æ ¼å¼ç¬¦åˆé¡¹ç›®è§„èŒƒ
- [ ] æäº¤æ¶ˆæ¯ç¬¦åˆ Conventional Commits è§„èŒƒ
- [ ] æ•æ„Ÿä¿¡æ¯å·²ç§»é™¤
- [ ] ç›¸å…³æ–‡æ¡£å·²æ›´æ–°

---

## 3. æµ‹è¯•è§„èŒƒ

### 3.1 æµ‹è¯•é‡‘å­—å¡”

#### ğŸ—ï¸ æµ‹è¯•å±‚æ¬¡ç»“æ„
```
        /\
       /  \
      / UI \
     /______\
    /        \
   /   é›†æˆ   \
  /    æµ‹è¯•    \
 /______________\
/                \
/     å•å…ƒæµ‹è¯•    \
/__________________\
```

### 3.2 å•å…ƒæµ‹è¯•è§„èŒƒ

#### ğŸ¯ æµ‹è¯•è¦†ç›–è¦æ±‚
| ç»„ä»¶ç±»å‹ | è¦†ç›–ç‡è¦æ±‚ | é‡ç‚¹æµ‹è¯•å†…å®¹ |
|---------|------------|--------------|
| **ä¸šåŠ¡é€»è¾‘** | > 90% | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€è¾¹ç•Œæ¡ä»¶ |
| **å·¥å…·å‡½æ•°** | > 95% | æ‰€æœ‰åˆ†æ”¯ã€å¼‚å¸¸æƒ…å†µ |
| **APIæ§åˆ¶å™¨** | > 80% | è¯·æ±‚éªŒè¯ã€å“åº”æ ¼å¼ |
| **æ•°æ®æ¨¡å‹** | > 85% | æ•°æ®éªŒè¯ã€å…³è”å…³ç³» |

#### ğŸ§ª å•å…ƒæµ‹è¯•ç¤ºä¾‹ (Python)
```python
# tests/test_tenant_service.py
import pytest
from unittest.mock import Mock, patch
from app.services.tenant_service import TenantService
from app.exceptions import TenantNotFoundError

class TestTenantService:
    @pytest.fixture
    def tenant_service(self):
        return TenantService()
    
    def test_get_tenant_by_id_success(self, tenant_service):
        """æµ‹è¯•é€šè¿‡IDè·å–ç§Ÿæˆ· - æˆåŠŸåœºæ™¯"""
        # Arrange
        tenant_id = "tenant_123"
        expected_tenant = {"id": tenant_id, "name": "Test Tenant"}
        
        with patch.object(tenant_service.db, 'get_tenant') as mock_get:
            mock_get.return_value = expected_tenant
            
            # Act
            result = tenant_service.get_tenant_by_id(tenant_id)
            
            # Assert
            assert result == expected_tenant
            mock_get.assert_called_once_with(tenant_id)
    
    def test_get_tenant_by_id_not_found(self, tenant_service):
        """æµ‹è¯•é€šè¿‡IDè·å–ç§Ÿæˆ· - æœªæ‰¾åˆ°åœºæ™¯"""
        # Arrange
        tenant_id = "nonexistent_tenant"
        
        with patch.object(tenant_service.db, 'get_tenant') as mock_get:
            mock_get.return_value = None
            
            # Act & Assert
            with pytest.raises(TenantNotFoundError):
                tenant_service.get_tenant_by_id(tenant_id)
```

#### ğŸ§ª å•å…ƒæµ‹è¯•ç¤ºä¾‹ (TypeScript)
```typescript
// tests/components/MessageList.test.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { mount } from '@vue/test-utils'
import MessageList from '@/components/MessageList.vue'
import type { Message } from '@/types'

describe('MessageList', () => {
  let wrapper: VueWrapper<any>
  const mockMessages: Message[] = [
    {
      id: '1',
      content: 'Hello world',
      type: 'text',
      sender: 'user',
      timestamp: '2024-01-01T10:00:00Z'
    }
  ]

  beforeEach(() => {
    wrapper = mount(MessageList, {
      props: {
        messages: mockMessages
      }
    })
  })

  it('renders message list correctly', () => {
    expect(wrapper.find('.message-list').exists()).toBe(true)
    expect(wrapper.findAll('.message-item')).toHaveLength(1)
  })

  it('displays message content', () => {
    const messageContent = wrapper.find('.message-content')
    expect(messageContent.text()).toBe('Hello world')
  })

  it('emits message-click event when message is clicked', async () => {
    await wrapper.find('.message-item').trigger('click')
    expect(wrapper.emitted('message-click')).toHaveLength(1)
    expect(wrapper.emitted('message-click')?.[0]).toEqual(['1'])
  })
})
```

### 3.3 é›†æˆæµ‹è¯•è§„èŒƒ

#### ğŸ”— APIå¥‘çº¦æµ‹è¯•
```python
# tests/integration/test_message_api.py
import pytest
import json
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

class TestMessageAPI:
    def test_post_message_success(self):
        """æµ‹è¯•å‘é€æ¶ˆæ¯API - æˆåŠŸåœºæ™¯"""
        # Arrange
        payload = {
            "content": "Hello, World!",
            "type": "text",
            "session_id": "session_123"
        }
        headers = {"Authorization": "Bearer valid_token"}
        
        # Act
        response = client.post("/api/v1/messages", 
                             json=payload, 
                             headers=headers)
        
        # Assert
        assert response.status_code == 201
        response_data = response.json()
        assert response_data["content"] == payload["content"]
        assert "id" in response_data
        assert "timestamp" in response_data

    def test_post_message_unauthorized(self):
        """æµ‹è¯•å‘é€æ¶ˆæ¯API - æœªæˆæƒåœºæ™¯"""
        payload = {"content": "Hello", "type": "text"}
        
        response = client.post("/api/v1/messages", json=payload)
        
        assert response.status_code == 401
        assert "Unauthorized" in response.json()["detail"]
```

### 3.4 ç«¯åˆ°ç«¯æµ‹è¯•è§„èŒƒ

#### ğŸ­ E2Eæµ‹è¯•ç¤ºä¾‹ (Playwright)
```typescript
// tests/e2e/customer-service.spec.ts
import { test, expect } from '@playwright/test'

test.describe('å®¢æœå·¥ä½œå°', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login')
    await page.fill('[data-testid="username"]', 'staff@example.com')
    await page.fill('[data-testid="password"]', 'password123')
    await page.click('[data-testid="login-button"]')
    await expect(page).toHaveURL('/dashboard')
  })

  test('æ¥æ”¶å¹¶å›å¤å®¢æˆ·æ¶ˆæ¯', async ({ page }) => {
    // ç­‰å¾…æ–°æ¶ˆæ¯é€šçŸ¥
    await expect(page.locator('[data-testid="message-notification"]')).toBeVisible()
    
    // ç‚¹å‡»ä¼šè¯
    await page.click('[data-testid="session-item"]:first-child')
    
    // éªŒè¯æ¶ˆæ¯æ˜¾ç¤º
    await expect(page.locator('[data-testid="message-content"]')).toContainText('ç”¨æˆ·é—®é¢˜')
    
    // å›å¤æ¶ˆæ¯
    await page.fill('[data-testid="reply-input"]', 'æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼Œæˆ‘æ¥ä¸ºæ‚¨è§£ç­”')
    await page.click('[data-testid="send-button"]')
    
    // éªŒè¯å›å¤å‘é€æˆåŠŸ
    await expect(page.locator('[data-testid="message-sent"]')).toBeVisible()
  })
})
```

---

## 4. ä»£ç å®¡æŸ¥è§„èŒƒ

### 4.1 å®¡æŸ¥æµç¨‹

#### ğŸ”„ PR/MR å·¥ä½œæµç¨‹
```mermaid
graph TD
    A[åˆ›å»ºPR] --> B[CI/CDæ£€æŸ¥]
    B --> C{æ£€æŸ¥é€šè¿‡?}
    C -->|å¦| D[ä¿®å¤é—®é¢˜]
    D --> B
    C -->|æ˜¯| E[æŒ‡å®šå®¡æŸ¥è€…]
    E --> F[ä»£ç å®¡æŸ¥]
    F --> G{å®¡æŸ¥é€šè¿‡?}
    G -->|å¦| H[ä¿®æ”¹ä»£ç ]
    H --> F
    G -->|æ˜¯| I[åˆå¹¶ä»£ç ]
    I --> J[åˆ é™¤åˆ†æ”¯]
```

### 4.2 å®¡æŸ¥æ¸…å•

#### âœ… ä»£ç è´¨é‡æ£€æŸ¥
```yaml
åŠŸèƒ½æ­£ç¡®æ€§:
  - [ ] ä»£ç å®ç°äº†éœ€æ±‚è§„æ ¼è¯´æ˜ä¸­çš„åŠŸèƒ½
  - [ ] å¤„ç†äº†æ‰€æœ‰è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ
  - [ ] æ²¡æœ‰å¼•å…¥æ–°çš„Bug

ä»£ç è®¾è®¡:
  - [ ] éµå¾ªSOLIDåŸåˆ™
  - [ ] åˆç†çš„æŠ½è±¡å’Œå°è£…
  - [ ] æ²¡æœ‰é‡å¤ä»£ç 
  - [ ] å‡½æ•°/ç±»èŒè´£å•ä¸€

æ€§èƒ½è€ƒè™‘:
  - [ ] æ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½é—®é¢˜
  - [ ] æ•°æ®åº“æŸ¥è¯¢å·²ä¼˜åŒ–
  - [ ] æ²¡æœ‰ä¸å¿…è¦çš„å¾ªç¯åµŒå¥—

å®‰å…¨æ€§:
  - [ ] è¾“å…¥éªŒè¯å……åˆ†
  - [ ] æ²¡æœ‰ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
  - [ ] æƒé™æ£€æŸ¥æ­£ç¡®
  - [ ] å¤šç§Ÿæˆ·éš”ç¦»æœ‰æ•ˆ
```

#### ğŸ“ å®¡æŸ¥è¯„è®ºè§„èŒƒ
```markdown
# å¥½çš„å®¡æŸ¥è¯„è®ºç¤ºä¾‹

## å»ºè®®æ”¹è¿›
è¿™é‡Œçš„æ•°æ®åº“æŸ¥è¯¢å¯èƒ½å­˜åœ¨N+1é—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨joinæ¥ä¼˜åŒ–ï¼š
```python
# å½“å‰å®ç°
sessions = Session.all()
for session in sessions:
    print(session.user.name)  # æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“

# å»ºè®®ä¼˜åŒ–
sessions = Session.select_related('user').all()
for session in sessions:
    print(session.user.name)  # ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æ•°æ®
```

## å®‰å…¨é—®é¢˜
è¿™é‡Œç¼ºå°‘ç§Ÿæˆ·IDéªŒè¯ï¼Œå¯èƒ½å¯¼è‡´è·¨ç§Ÿæˆ·æ•°æ®è®¿é—®ï¼š
```python
# å½“å‰å®ç°
message = Message.objects.get(id=message_id)

# å»ºè®®ä¿®å¤
message = Message.objects.get(id=message_id, tenant_id=current_tenant.id)
```
```

---

## 5. å®‰å…¨ç¼–ç è§„èŒƒ

### 5.1 OWASP Top 10 é˜²æŠ¤

#### ğŸ›¡ï¸ å®‰å…¨ç¼–ç æ£€æŸ¥æ¸…å•
| å®‰å…¨é£é™© | é˜²æŠ¤æªæ–½ | ä»£ç ç¤ºä¾‹ |
|---------|----------|----------|
| **SQLæ³¨å…¥** | ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ | `SELECT * FROM users WHERE id = %s` |
| **XSSæ”»å‡»** | è¾“å‡ºè½¬ä¹‰ | `escape(user_input)` |
| **CSRFæ”»å‡»** | CSRF TokenéªŒè¯ | `@csrf_protect` |
| **è®¤è¯ç»•è¿‡** | ä¸¥æ ¼æƒé™æ£€æŸ¥ | `@require_authentication` |

#### ğŸ” æ•æ„Ÿä¿¡æ¯å¤„ç†
```python
# âŒ é”™è¯¯åšæ³• - ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
DATABASE_PASSWORD = "admin123"
API_KEY = "sk-1234567890abcdef"

# âœ… æ­£ç¡®åšæ³• - ä½¿ç”¨ç¯å¢ƒå˜é‡
import os
DATABASE_PASSWORD = os.getenv("DATABASE_PASSWORD")
API_KEY = os.getenv("OPENAI_API_KEY")

# âœ… æ›´å¥½çš„åšæ³• - ä½¿ç”¨é…ç½®ç®¡ç†
from app.config import settings
DATABASE_PASSWORD = settings.database_password
API_KEY = settings.llm_api_key
```

### 5.2 è¾“å…¥éªŒè¯è§„èŒƒ

#### ğŸ“ æ•°æ®éªŒè¯ç¤ºä¾‹
```python
# ä½¿ç”¨Pydanticè¿›è¡Œä¸¥æ ¼çš„æ•°æ®éªŒè¯
from pydantic import BaseModel, validator
from typing import Optional

class MessageCreateRequest(BaseModel):
    content: str
    message_type: str
    session_id: str
    
    @validator('content')
    def validate_content(cls, v):
        if not v or len(v.strip()) == 0:
            raise ValueError('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º')
        if len(v) > 10000:
            raise ValueError('æ¶ˆæ¯å†…å®¹è¿‡é•¿')
        return v.strip()
    
    @validator('message_type')
    def validate_message_type(cls, v):
        allowed_types = ['text', 'image', 'voice', 'file']
        if v not in allowed_types:
            raise ValueError(f'ä¸æ”¯æŒçš„æ¶ˆæ¯ç±»å‹: {v}')
        return v

# APIç«¯ç‚¹ä½¿ç”¨éªŒè¯
@app.post("/api/v1/messages")
async def create_message(request: MessageCreateRequest):
    # Pydanticè‡ªåŠ¨éªŒè¯è¯·æ±‚æ•°æ®
    pass
```

---

## 6. å¤šç§Ÿæˆ·å¼€å‘è§„èŒƒ

### 6.1 æ•°æ®éš”ç¦»åŸåˆ™

#### ğŸ¢ ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†
```python
# ç§Ÿæˆ·ä¸­é—´ä»¶ç¤ºä¾‹
from starlette.middleware.base import BaseHTTPMiddleware
from app.context import set_current_tenant

class TenantMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, call_next):
        # ä»JWT tokenä¸­æå–ç§Ÿæˆ·ID
        tenant_id = extract_tenant_from_token(request)
        
        # è®¾ç½®å½“å‰ç§Ÿæˆ·ä¸Šä¸‹æ–‡
        set_current_tenant(tenant_id)
        
        try:
            response = await call_next(request)
            return response
        finally:
            # æ¸…ç†ç§Ÿæˆ·ä¸Šä¸‹æ–‡
            set_current_tenant(None)
```

#### ğŸ“Š æ•°æ®åº“æŸ¥è¯¢è§„èŒƒ
```python
# âŒ é”™è¯¯åšæ³• - æ²¡æœ‰ç§Ÿæˆ·è¿‡æ»¤
def get_user_messages(user_id: str):
    return db.query(Message).filter(Message.user_id == user_id).all()

# âœ… æ­£ç¡®åšæ³• - åŒ…å«ç§Ÿæˆ·è¿‡æ»¤
def get_user_messages(user_id: str, tenant_id: str):
    return db.query(Message).filter(
        Message.user_id == user_id,
        Message.tenant_id == tenant_id
    ).all()

# âœ… æ›´å¥½çš„åšæ³• - ä½¿ç”¨ç§Ÿæˆ·ä¸Šä¸‹æ–‡
from app.context import get_current_tenant

def get_user_messages(user_id: str):
    tenant_id = get_current_tenant().id
    return db.query(Message).filter(
        Message.user_id == user_id,
        Message.tenant_id == tenant_id
    ).all()
```

### 6.2 APIå®‰å…¨è§„èŒƒ

#### ğŸ”’ æƒé™æ§åˆ¶è£…é¥°å™¨
```python
from functools import wraps
from app.exceptions import PermissionDeniedError

def require_tenant_access(func):
    """ç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±ç§Ÿæˆ·çš„èµ„æº"""
    @wraps(func)
    async def wrapper(*args, **kwargs):
        current_user = get_current_user()
        resource_tenant_id = kwargs.get('tenant_id')
        
        if current_user.tenant_id != resource_tenant_id:
            raise PermissionDeniedError("æ— æƒè®¿é—®å…¶ä»–ç§Ÿæˆ·èµ„æº")
        
        return await func(*args, **kwargs)
    return wrapper

# ä½¿ç”¨ç¤ºä¾‹
@app.get("/api/v1/tenants/{tenant_id}/messages")
@require_tenant_access
async def get_tenant_messages(tenant_id: str):
    return get_messages_by_tenant(tenant_id)
```

---

## 7. APIå¼€å‘è§„èŒƒ

### 7.1 RESTful APIè®¾è®¡

#### ğŸŒ URLè®¾è®¡è§„èŒƒ
```
# èµ„æºå‘½åä½¿ç”¨å¤æ•°åè¯
GET    /api/v1/messages          # è·å–æ¶ˆæ¯åˆ—è¡¨
POST   /api/v1/messages          # åˆ›å»ºæ–°æ¶ˆæ¯
GET    /api/v1/messages/{id}     # è·å–ç‰¹å®šæ¶ˆæ¯
PUT    /api/v1/messages/{id}     # æ›´æ–°ç‰¹å®šæ¶ˆæ¯
DELETE /api/v1/messages/{id}     # åˆ é™¤ç‰¹å®šæ¶ˆæ¯

# åµŒå¥—èµ„æº
GET    /api/v1/sessions/{id}/messages    # è·å–ä¼šè¯çš„æ¶ˆæ¯
POST   /api/v1/sessions/{id}/messages    # åœ¨ä¼šè¯ä¸­åˆ›å»ºæ¶ˆæ¯
```

#### ğŸ“‹ HTTPçŠ¶æ€ç è§„èŒƒ
| çŠ¶æ€ç  | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|--------|----------|------|
| **200** | æˆåŠŸè¿”å›æ•°æ® | GETè¯·æ±‚æˆåŠŸ |
| **201** | æˆåŠŸåˆ›å»ºèµ„æº | POSTåˆ›å»ºæˆåŠŸ |
| **204** | æˆåŠŸæ— è¿”å›å†…å®¹ | DELETEæˆåŠŸ |
| **400** | è¯·æ±‚å‚æ•°é”™è¯¯ | éªŒè¯å¤±è´¥ |
| **401** | æœªè®¤è¯ | ç¼ºå°‘æˆ–æ— æ•ˆtoken |
| **403** | æ— æƒé™ | è·¨ç§Ÿæˆ·è®¿é—® |
| **404** | èµ„æºä¸å­˜åœ¨ | IDä¸å­˜åœ¨ |
| **500** | æœåŠ¡å™¨é”™è¯¯ | ç³»ç»Ÿå¼‚å¸¸ |

#### ğŸ“ å“åº”æ ¼å¼è§„èŒƒ
```json
// æˆåŠŸå“åº”
{
  "success": true,
  "data": {
    "id": "msg_123",
    "content": "Hello world",
    "timestamp": "2024-01-01T10:00:00Z"
  },
  "meta": {
    "total": 100,
    "page": 1,
    "per_page": 20
  }
}

// é”™è¯¯å“åº”
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥",
    "details": {
      "content": ["æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º"]
    }
  },
  "request_id": "req_123456"
}
```

### 7.2 APIæ–‡æ¡£è§„èŒƒ

#### ğŸ“– OpenAPIè§„èŒƒç¤ºä¾‹
```python
from pydantic import BaseModel
from fastapi import FastAPI, HTTPException

app = FastAPI(
    title="AstrBot SaaS API",
    description="æ™ºèƒ½å®¢æœSaaSå¹³å°APIæ–‡æ¡£",
    version="1.0.0"
)

class MessageResponse(BaseModel):
    """æ¶ˆæ¯å“åº”æ¨¡å‹"""
    id: str
    content: str
    type: str
    timestamp: str
    
    class Config:
        schema_extra = {
            "example": {
                "id": "msg_123",
                "content": "Hello world",
                "type": "text",
                "timestamp": "2024-01-01T10:00:00Z"
            }
        }

@app.get(
    "/api/v1/messages/{message_id}",
    response_model=MessageResponse,
    summary="è·å–æ¶ˆæ¯è¯¦æƒ…",
    description="æ ¹æ®æ¶ˆæ¯IDè·å–æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯",
    responses={
        200: {"description": "æˆåŠŸè¿”å›æ¶ˆæ¯ä¿¡æ¯"},
        404: {"description": "æ¶ˆæ¯ä¸å­˜åœ¨"},
        403: {"description": "æ— æƒé™è®¿é—®è¯¥æ¶ˆæ¯"}
    }
)
async def get_message(message_id: str):
    """
    è·å–æŒ‡å®šIDçš„æ¶ˆæ¯è¯¦æƒ…
    
    Args:
        message_id: æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦
        
    Returns:
        MessageResponse: æ¶ˆæ¯è¯¦ç»†ä¿¡æ¯
        
    Raises:
        HTTPException: å½“æ¶ˆæ¯ä¸å­˜åœ¨æˆ–æ— æƒé™æ—¶
    """
    pass
```

---

## 8. æ–‡æ¡£åŒæ­¥è§„èŒƒ

### 8.1 æ–‡æ¡£æ›´æ–°è¦æ±‚

#### ğŸ“š å¿…é¡»æ›´æ–°çš„æ–‡æ¡£
```yaml
APIå˜æ›´æ—¶:
  - OpenAPIè§„èŒƒæ–‡æ¡£
  - APIä½¿ç”¨ç¤ºä¾‹
  - é”™è¯¯ç è¯´æ˜
  - è®¤è¯æ–¹å¼è¯´æ˜

æ•°æ®åº“å˜æ›´æ—¶:
  - æ•°æ®åº“è¡¨ç»“æ„æ–‡æ¡£
  - æ•°æ®å­—å…¸
  - è¿ç§»è„šæœ¬è¯´æ˜

é…ç½®å˜æ›´æ—¶:
  - éƒ¨ç½²æ–‡æ¡£
  - ç¯å¢ƒå˜é‡è¯´æ˜
  - é…ç½®é¡¹è¯´æ˜

åŠŸèƒ½å˜æ›´æ—¶:
  - ç”¨æˆ·æ‰‹å†Œ
  - åŠŸèƒ½è¯´æ˜æ–‡æ¡£
  - æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£
```

### 8.2 æ–‡æ¡£è´¨é‡æ ‡å‡†

#### âœ… æ–‡æ¡£æ£€æŸ¥æ¸…å•
- [ ] æ–‡æ¡£å†…å®¹å‡†ç¡®æ— è¯¯
- [ ] ä»£ç ç¤ºä¾‹å¯ä»¥è¿è¡Œ
- [ ] åŒ…å«å®Œæ•´çš„è¾“å…¥è¾“å‡ºç¤ºä¾‹
- [ ] é”™è¯¯å¤„ç†åœºæ™¯æœ‰è¯´æ˜
- [ ] ç‰ˆæœ¬ä¿¡æ¯å·²æ›´æ–°
- [ ] é“¾æ¥åœ°å€æœ‰æ•ˆ

---

## ğŸ“‹ å¼€å‘è§„èŒƒæ€»ç»“

### âœ… æ ¸å¿ƒåŸåˆ™
- **å®‰å…¨ç¬¬ä¸€**: æ‰€æœ‰ä»£ç éƒ½è¦ç»è¿‡å®‰å…¨æ£€æŸ¥
- **è´¨é‡ä¿è¯**: é€šè¿‡æµ‹è¯•å’Œä»£ç å®¡æŸ¥ç¡®ä¿è´¨é‡
- **æ–‡æ¡£åŒæ­¥**: ä»£ç å˜æ›´å¿…é¡»åŒæ­¥æ›´æ–°æ–‡æ¡£
- **å¤šç§Ÿæˆ·æ„è¯†**: æ—¶åˆ»æ³¨æ„æ•°æ®éš”ç¦»å’Œæƒé™æ§åˆ¶

### âœ… æ‰§è¡Œä¿éšœ
- **è‡ªåŠ¨åŒ–æ£€æŸ¥**: CI/CDæµæ°´çº¿è‡ªåŠ¨æ‰§è¡Œè§„èŒƒæ£€æŸ¥
- **å¼ºåˆ¶å®¡æŸ¥**: æ‰€æœ‰ä»£ç å¿…é¡»ç»è¿‡å®¡æŸ¥æ‰èƒ½åˆå¹¶
- **å®šæœŸå›é¡¾**: å®šæœŸå›é¡¾å’Œæ›´æ–°å¼€å‘è§„èŒƒ
- **åŸ¹è®­ä½“ç³»**: æ–°æˆå‘˜å¿…é¡»æ¥å—è§„èŒƒåŸ¹è®­

---

**è§„èŒƒç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024å¹´  
**ä¸‹ä¸€æ­¥**: å›¢é˜ŸåŸ¹è®­å’Œè§„èŒƒè½åœ°æ‰§è¡Œ